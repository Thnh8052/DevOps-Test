<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Người dùng</title>
    
    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        *{
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        }
        body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
        background: #f5f5f5;
        }
        .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white; 
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
        margin-bottom: 20px;
        color: #333;
        text-align: center;
        }
        
        /* Search Bar & Toolbar */
        .toolbar { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .search-bar { flex: 1; margin-bottom: 0; }
        .search-bar input {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 2px solid #ddd;
        border-radius: 4px;
        }
        
        /* Table */
        .table-wrapper { overflow-x: auto; } /* Wrapper cho responsive */
        table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        }
        th, td {
        padding: 12px;
        text-align: left;
        border: 1px solid #ddd;
        }
        th {
        background: #4CAF50;
        color: white;
        font-weight: bold;
        }
        tr:nth-child(even) {
        background: #f9f9f9;
        }
        tr:hover {
        background: #f5f5f5;
        }
        
        /* Buttons */
        button {
        padding: 8px 16px;
        margin: 0 4px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        }
        /* chuyển trang */
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; flex-wrap: wrap; }
        .pagination-info { color: #666; font-size: 14px; }
        .page-info { margin: 0 10px; font-weight: bold; color: #444; }
        .select-margin { margin: 0 8px; }

        /* modal thêm mới */
        .modal-overlay { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.5); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
        }
        .modal-content { 
            background: white; 
            padding: 25px; 
            width: 400px; 
            border-radius: 8px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            animation: modal-open 0.3s cubic-bezier(0.2, 0.8, 0.4, 1.2); 
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .modal-actions { text-align: right; margin-top: 20px; }
        .modal-actions button { margin-left: 10px; }


        @keyframes modal-open {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @media (max-width: 768px) {
            table { display: block; overflow-x: auto; white-space: nowrap; }
            .modal-content { width: 90%; margin: 0 10px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
    // Component Thanh tìm kiếm
    //     function SearchBar({ value, onChange }) {
    //     return (
    //     <div className="search-bar">
    //     <input
    //     type="text"
    //     placeholder="Tìm theo tên, email, địa chỉ..."
    //     value={value}
    //     onChange={(e) => onChange(e.target.value)}
    //     style={{ width: '100%', padding: '10px', fontSize: '16px' }}
    //     />
    //    </div>
    //     );
    // }
        const API_BASE_URL = "https://devops-test-k744.onrender.com";

        const { useState, useEffect } = React;

        //SearchBar (Debounce)
        function SearchBar({ onChange }) {
            const [searchInput, setSearchInput] = useState("");
            useEffect(() => {
                const timer = setTimeout(() => onChange(searchInput), 500);
                return () => clearTimeout(timer);
            }, [searchInput]);
            return (
                <div className="search-bar">
                    <input 
                        className="search-input" 
                        type="text" 
                        placeholder="Tìm kiếm theo tên, email..." 
                        value={searchInput} 
                        onChange={(e) => setSearchInput(e.target.value)} 
                    />
                </div>
            );
        }

        //UserTable
        //thêm page,limit để tính số thứ tự
        function UserTable({ users, page, limit, onEdit, onDelete }) {
            const handleDelete = (id, name) => {
                if (window.confirm(`Bạn có chắc muốn xóa "${name}"?`)) onDelete(id);
            };

            return (
                <div className="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Họ tên</th>
                                <th>Tuổi</th>
                                <th>Email</th>
                                <th>Địa chỉ</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            {users.length === 0 ? (
                                <tr><td colSpan="6">Không tìm thấy dữ liệu nào</td></tr>
                            ) : (
                                users.map((user, index) => (
                                    //tính số thứ tự
                                    <tr key={user._id}>
                                        <td>
                                            {(page - 1) * limit + index + 1}
                                        </td>
                                        <td>{user.name}</td>
                                        <td>{user.age}</td>
                                        <td>{user.email}</td>
                                        <td>{user.address || "-"}</td>
                                        <td>
                                            <button className="btn-edit" onClick={() => onEdit(user)}>Sửa</button>
                                            <button className="btn-delete" onClick={() => handleDelete(user._id, user.name)}>Xóa</button>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            );
        }

        // 3. Pagination
        function Pagination({ page, totalPages, limit, onPageChange, onLimitChange }) {
            return (
                <div className="pagination">
                    <div className="pagination-info">
                        Hiển thị 
                        <select 
                            value={limit} 
                            onChange={(e) => onLimitChange(Number(e.target.value))}
                            className="select-margin"
                        >
                            <option value="3">3</option>
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                        </select> 
                        dòng / trang
                    </div>
                    <div className="pagination-controls">
                        <button disabled={page <= 1} onClick={() => onPageChange(page - 1)}>
                             Trước
                        </button>
                        <span className="page-info">
                            Trang {page} / {totalPages || 1}
                        </span>
                        <button disabled={page >= totalPages} onClick={() => onPageChange(page + 1)}>
                            Sau 
                        </button>
                    </div>
                </div>
            );
        }

        //UserModal
        function UserModal({ user, onClose, onSave }) {
            const [formData, setFormData] = useState(
                user || { name: "", age: "", email: "", address: "" }
            );
            const [errors, setErrors] = useState({});

            const handleChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
                if (errors[e.target.name]) {
                    setErrors({...errors, [e.target.name]: null});
                }
            };

            const validate = (data) => {
                const newErrors = {};
                if (!data.name || data.name.length < 2) newErrors.name = "Tên phải có ít nhất 2 ký tự";
                if (data.age === "" || data.age < 0) newErrors.age = "Tuổi phải là số dương";
                if (!data.email || !/^\S+@\S+\.\S+$/.test(data.email)) newErrors.email = "Email không đúng định dạng";
                
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = () => {
                const cleanData = {
                    ...formData,
                    name: formData.name.trim(),//chuẩn hóa dữ liệu
                    email: formData.email.trim(),//chuẩn hóa dữ liệu
                    address: formData.address ? formData.address.trim() : "",//chuẩn hóa dữ liệu
                    age: Number(formData.age)
                };

                if (!validate(cleanData)) return;

                const url = user 
                    ? `${API_BASE_URL}/api/users/${user._id}`
                    : `${API_BASE_URL}/api/users`;
                const method = user ? "PUT" : "POST";

                fetch(url, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(cleanData)
                })
                .then(async res => {
                    const data = await res.json();
                    if (!res.ok) {
                        throw new Error(data.error || "Có lỗi xảy ra");
                    }
                    return data;
                })
                .then(data => {
                    alert(data.message || "Thao tác thành công!");
                    onSave();
                })
                .catch(err => alert("Lỗi: " + err.message));
            };

            return (
                <div className="modal-overlay" onMouseDown={onClose}>
                    <div className="modal-content" onMouseDown={e => e.stopPropagation()}>
                        <h3>{user ? "Cập nhật thông tin" : "Thêm người dùng mới"}</h3>
                        
                        <div className="form-group">
                            <label>Họ tên (*)</label>
                            <input name="name" value={formData.name} onChange={handleChange} placeholder="VD: Nguyễn Văn A" />
                            {errors.name && <p className="error-msg">{errors.name}</p>}
                        </div>
                        <div className="form-group">
                            <label>Tuổi (*)</label>
                            <input name="age" type="number" value={formData.age} onChange={handleChange} placeholder="VD: 20" />
                            {errors.age && <p className="error-msg">{errors.age}</p>}
                        </div>
                        <div className="form-group">
                            <label>Email (*)</label>
                            <input name="email" value={formData.email} onChange={handleChange} placeholder="VD: email@example.com" />
                            {errors.email && <p className="error-msg">{errors.email}</p>}
                        </div>
                        <div className="form-group">
                            <label>Địa chỉ</label>
                            <input name="address" value={formData.address} onChange={handleChange} placeholder="VD: Hà Nội" />
                        </div>
                        <div className="modal-actions">
                            <button className="btn-cancel-modal" onClick={onClose}>Hủy bỏ</button>
                            <button className="btn-save-modal" onClick={handleSubmit}>Lưu thông tin</button>
                        </div>
                    </div>
                </div>
            );
        }

        //App Component
        function App() {
            const [users, setUsers] = useState([]);
            const [page, setPage] = useState(1);
            const [limit, setLimit] = useState(5);
            const [search, setSearch] = useState("");
            const [totalPages, setTotalPages] = useState(0);
            
            const [showModal, setShowModal] = useState(false);
            const [editingUser, setEditingUser] = useState(null);

            const fetchUsers = () => {
                fetch(`${API_BASE_URL}/api/users?page=${page}&limit=${limit}&search=${search}`)
                    .then(res => res.json())
                    .then(data => {
                        setUsers(data.data || []);
                        setTotalPages(data.totalPages || 0);
                    })
                    .catch(err => console.error("Err:", err));
            };

            useEffect(() => { fetchUsers(); }, [page, limit, search]);

            const deleteUser = (id) => {
                fetch(`${API_BASE_URL}/api/users/${id}`, { method: "DELETE" })
                    .then(async res => {
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error);
                        return data;
                    })
                    .then(data => {
                        alert(data.message);
                        if (users.length === 1 && page > 1) {
                            setPage(page - 1);
                        } else {
                            fetchUsers();
                        }
                    })
                    .catch(err => alert("Lỗi xóa: " + err.message));
            };

            return (
                <div className="container">
                    <h1>Quản lý Người dùng</h1>
                    <div className="toolbar">
                        <SearchBar onChange={(val) => { setSearch(val); setPage(1); }} />
                        <button className="btn-add" onClick={() => { setEditingUser(null); setShowModal(true); }}>
                            + Thêm mới
                        </button>
                    </div>

                    <UserTable 
                        users={users} 
                        page={page}
                        limit={limit}
                        onEdit={(user) => { setEditingUser(user); setShowModal(true); }}
                        onDelete={deleteUser}
                    />

                    <Pagination 
                        page={page} totalPages={totalPages} limit={limit}
                        onPageChange={setPage}
                        onLimitChange={(val) => { setLimit(val); setPage(1); }}
                    />

                    {showModal && (
                        <UserModal 
                            user={editingUser}
                            onClose={() => setShowModal(false)}
                            onSave={() => { fetchUsers(); setShowModal(false); }}
                        />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>